# Copyright (c) 2005-2009 Jaroslav Gresula
#
# Distributed under the MIT license (See accompanying file
# LICENSE.txt or copy at http://jagpdf.org/LICENSE.txt)
#


if(JAG_STANDALONE_APITESTS)
  if(NOT JAG_APITEST_PY)
    return()
  else()
    if(NOT PYTHON_EXECUTABLE)
      message(FATAL_ERROR "Cannot run tests: Python environment not found.")
    endif()
  endif()
endif()


set(TEST_PDF_OUTPUT_DIR ${CMAKE_BINARY_DIR}/pdf-output/py)
file(MAKE_DIRECTORY ${TEST_PDF_OUTPUT_DIR})
set_property(DIRECTORY APPEND PROPERTY TEST_INCLUDE_FILE ${JAG_TEST_ENV})

set(tests
  basic
  docoutline
  annots
  adobefont
  adobefont_unicode
  ttfmonosubset
  opentypecff
  externalstream
  pathconstr-bad
  pattern-nonstd-op
  swigabort
  config
  canvas
  version
  basictxtfmt
  defaultfont
  kerning
  kerning2
  textstate
  defaulttxtenc
  defaultargs
  defaultfont2
  docexamples
  winfontmatch
  encrypt
  infodict
  shading_pattern
  grstatemachine
  cubespng
  # legacy
  colorspaces
  color-space-str-def
  colorstate
  customimage
  customsmask
  deflated
  fonts_in_1_2
  fonttypes
  graphics_state
  imageexplicitprops
  img-gamma
  img-jpeg
  img-jpegicc-1_2
  img-jpeg-srgb2calrgb
  img-png-srgb
  pdffont_basic
  png-test-suite
  smask16
  smask-color
  tiling_patterns
  tux
  fullpagefmt
  imageclip
  text_spiral
  arc_test
  piechart
  autodetectimg
  sun_patterns
  functions
  invoice
  confidential
  initialview
  #clock
  topdown
  topdown2
  topdown3
  glyph_index
  dark_reader
  compressed_pattern
  doctitle
  jpeg_icc_gray
  nosubset
  # tickets
  symbolswidth
  t0068
  t0115
  t0133
)

# add_test(api_py_check_remove ${CMAKE_COMMAND} -E remove ${TEST_PDF_OUTPUT_DIR}/*.pdf)
# add_test(api_py_check_copy ${CMAKE_COMMAND} -E copy_if_different ${CMAKE_CURRENT_SOURCE_DIR}/.outfiles ${TEST_PDF_OUTPUT_DIR}/.outfiles)

foreach(test ${tests})
  add_test(api_py_${test} ${PYTHON_EXECUTABLE} -u "${CMAKE_CURRENT_SOURCE_DIR}/${test}.py" ${TEST_PDF_OUTPUT_DIR})
endforeach(test)

add_test(api_infinite_py ${PYTHON_EXECUTABLE} -u "${CMAKE_CURRENT_SOURCE_DIR}/long_test.py" ${TEST_PDF_OUTPUT_DIR})
set_tests_properties(api_infinite_py PROPERTIES TIMEOUT 1000000)


macro(apitests_py_generic NAME TEST_REX MEMCHECK)
  add_custom_target(${NAME}
    COMMAND ${CMAKE_COMMAND} -E remove ${TEST_PDF_OUTPUT_DIR}/*.pdf
    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${CMAKE_CURRENT_SOURCE_DIR}/.outfiles ${TEST_PDF_OUTPUT_DIR}/.outfiles
    COMMAND ${JAG_MYCTEST_SH} ${MEMCHECK} ${CMAKE_CTEST_COMMAND} -R ${TEST_REX}
    COMMAND ${CMAKE_COMMAND} -E echo "-- Verifying PDF files generated by target apitests-py"
    COMMAND ${JAG_COMPARE_PDF} --verify-list --out-dir=${TEST_PDF_OUTPUT_DIR} --good-dir=${PDF_REFERENCE_DIR}
    WORKING_DIRECTORY "${CMAKE_BINARY_DIR}"
    )
endmacro(apitests_py_generic)

apitests_py_generic(apitests-py api_py_ "")
apitests_py_generic(apitests-py-memcheck api_py_ "${JAG_HAVE_MEMCHECK}")
apitests_py_generic(apitests-infinite-py api_infinite_py "")

add_dependencies(apitests apitests-py)
add_dependencies(apitests-memcheck apitests-py-memcheck)


